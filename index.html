<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>LED Arena Counter - Fixed & Protected</title>
<style>
html, body {
  margin:0; padding:0;
  width:100%; height:100%;
  background:black;
  overflow:hidden;
  user-select:none; 
  -webkit-user-select:none;
  font-family:'Arial Black',Arial,sans-serif;
}

/* FULLSCREEN TOGGLE */
#fs-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: rgba(255,255,255,0.05);
  color: #444;
  border: 1px solid #222;
  padding: 8px;
  border-radius: 4px;
  cursor: pointer;
  z-index: 100;
  font-size: 10px;
}

#container{
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  height:100%;
  padding-top:12vh;
}

#cockpit-name {
  position: fixed;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  color:#00ffff;
  font-size:6vw;
  text-align:center;
  cursor:text;
  font-weight:bold;
  z-index: 20;
}

.stage{
  position: relative;
  font-size:8vw;
  margin:1vh 0;
  width: 80%;
  display:flex;
  justify-content:center;
  align-items:center;
}

.stage-text {
  position: relative;
  z-index: 1;
  cursor: pointer;
  font-weight: bold;
  text-shadow: 0 0 10px currentColor;
  transition: all 0.2s ease;
}

.jump-zone {
  position: absolute;
  top:0; left:0; right:0; bottom:0;
  z-index:0;
}

#ready{color:#00ff4c;}
#limber{color:#ffffff;}
#helling-area{color:#ff2a2a;}
.active{ transform:scale(1.05); }

/* ANIMATIONS */
.pulse { animation: pulseGlow 0.7s infinite alternate; }
@keyframes pulseGlow{
  0% { text-shadow: 0 0 20px currentColor, 0 0 40px currentColor, 0 0 60px currentColor; }
  100% { text-shadow: 0 0 40px currentColor, 0 0 80px currentColor, 0 0 120px currentColor; }
}

.highlight-glow {
  position: relative;
  animation: neonGlow 0.7s infinite alternate;
  z-index: 2;
}
@keyframes neonGlow {
  0% { text-shadow: 0 0 5px currentColor, 0 0 20px currentColor; }
  100% { text-shadow: 0 0 20px currentColor, 0 0 60px currentColor; }
}

/* MODAL STYLES */
#modal{
  position: fixed;
  top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.85);
  display: none; /* Controlled by JS */
  justify-content: center;
  align-items: center;
  z-index: 2000;
  opacity: 0;
  transition: opacity 0.3s ease;
}
#modal.show{ opacity:1; display: flex; }
#modal-content{
  background: #111;
  padding: 30px;
  border-radius: 15px;
  border: 1px solid #444;
  color:white;
  text-align:center;
  transform: scale(0.8);
  transition: transform 0.3s ease;
}
#modal.show #modal-content{ transform: scale(1); }
#modal-content input{
  width: 120px;
  font-size:2.5rem;
  background: #000;
  color: #00ff4c;
  border: 1px solid #555;
  text-align:center;
  margin: 20px 0;
}
#modal-content button{
  font-size:1.2rem;
  padding:12px 30px;
  background: #00ff4c;
  border: none;
  border-radius: 5px;
  cursor:pointer;
  font-weight: bold;
  color: black;
}
</style>
</head>
<body>

<button id="fs-btn" onclick="toggleFullScreen()">FULLSCREEN</button>

<div id="container">
  <div id="cockpit-name" contenteditable="true">ARENA 1</div>

  <div class="stage" id="ready">
    <div class="stage-text">READY <span class="number">1</span></div>
    <div class="jump-zone"></div>
  </div>
  <div class="stage" id="limber">
    <div class="stage-text">LIMBER <span class="number">1</span></div>
    <div class="jump-zone"></div>
  </div>
  <div class="stage" id="helling-area">
    <div class="stage-text">HELLING AREA <span class="number">1</span></div>
    <div class="jump-zone"></div>
  </div>
</div>

<audio id="beep" src="https://assets.mixkit.co/active_storage/sfx/212/212-preview.mp3"></audio>

<div id="modal">
  <div id="modal-content">
    <div id="modal-title" style="font-size: 1.5rem;">SET NUMBER</div>
    <input type="number" id="modal-input" min="1"/>
    <br>
    <button id="modal-ok">SAVE & GO</button>
    <p style="color: #666; font-size: 0.8rem; margin-top: 15px;">Tap outside to cancel</p>
  </div>
</div>

<script>
/* --- 1. SECURITY LOCKS --- */
document.addEventListener('contextmenu', e => e.preventDefault());
document.addEventListener('keydown', e => {
  // Block F12, Ctrl+U, Ctrl+Shift+I, etc.
  if (e.key === "F12" || (e.ctrlKey && (e.key === "u" || e.key === "s" || e.key === "p"))) {
    e.preventDefault();
    return false;
  }
  if (e.ctrlKey && e.shiftKey && (e.key === "I" || e.key === "J" || e.key === "C")) {
    e.preventDefault();
    return false;
  }
  // Allow Escape key to close modal even if logic is blocked
  if (e.key === "Escape") {
    hideModal();
  }
});

/* --- 2. FULLSCREEN --- */
function toggleFullScreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
  } else {
    if (document.exitFullscreen) document.exitFullscreen();
  }
}

/* --- 3. APP LOGIC --- */
let stages = ["READY","LIMBER","HELLING AREA"];
let stageNumbers = {"READY":1, "LIMBER":1, "HELLING AREA":1};
let stageIndex = 0;
const REPEAT_COUNT = 5;
const PAUSE_MS = 1500;
let longPressTimer = null;
let startY = null;

const stageEls = {
  "READY": document.getElementById("ready"),
  "LIMBER": document.getElementById("limber"),
  "HELLING AREA": document.getElementById("helling-area")
};
const beep = document.getElementById("beep");
const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modal-title");
const modalInput = document.getElementById("modal-input");
const modalOk = document.getElementById("modal-ok");
const cockpitEl = document.getElementById("cockpit-name");

function loadState(){
  const saved = localStorage.getItem('arenaState');
  if(saved){
    const data = JSON.parse(saved);
    stageNumbers = data.stageNumbers || stageNumbers;
    stageIndex = data.stageIndex || stageIndex;
  }
  const cockpitName = localStorage.getItem('cockpitName');
  if(cockpitName) cockpitEl.textContent = cockpitName;
}

function saveState(){
  localStorage.setItem('arenaState', JSON.stringify({
    stageNumbers: stageNumbers,
    stageIndex: stageIndex
  }));
}

cockpitEl.addEventListener("input", () => {
  localStorage.setItem('cockpitName', cockpitEl.textContent.trim());
});

function updateDisplay(){
  Object.values(stageEls).forEach(el => el.classList.remove("active","pulse"));
  let s = stages[stageIndex];
  stageEls[s].classList.add("active");
  stages.forEach(k => {
    stageEls[k].querySelector(".stage-text").innerHTML = `${k} <span class="number">${stageNumbers[k]}</span>`;
  });
  saveState();
}

function speak(text){
  return new Promise(resolve => {
    speechSynthesis.cancel();
    let u = new SpeechSynthesisUtterance(text);
    u.rate = 0.95;
    u.onend = resolve;
    speechSynthesis.speak(u);
  });
}

async function announce(){
  let stage = stages[stageIndex];
  let num = stageNumbers[stage];
  let text = `${stage} ${num}`;
  const textEl = stageEls[stage].querySelector(".stage-text");
  stageEls[stage].classList.add("pulse");

  let colorMap = {"READY": "#00ff4c", "LIMBER": "#ffffff", "HELLING AREA": "#ff2a2a"};
  
  for(let i=0; i<REPEAT_COUNT; i++){
    textEl.style.color = colorMap[stage];
    textEl.classList.add("highlight-glow");
    beep.currentTime = 0; 
    beep.play();
    await speak(text);
    textEl.classList.remove("highlight-glow");
    await new Promise(r => setTimeout(r, PAUSE_MS));
  }
  stageEls[stage].classList.remove("pulse");
}

/* --- MODAL FUNCTIONS --- */
function showModal(stageName){
  modalTitle.textContent = `JUMP ${stageName} TO:`;
  modalInput.value = stageNumbers[stageName];
  modal.style.display = "flex";
  setTimeout(() => modal.classList.add("show"), 10);
  modalInput.focus();
}

function hideModal(){
  modal.classList.remove("show");
  setTimeout(() => { modal.style.display = "none"; }, 300);
}

// Close when clicking background
modal.addEventListener("click", (e) => {
  if(e.target === modal) hideModal();
});

// Close when clicking OK
modalOk.addEventListener("click", () => {
  let n = parseInt(modalInput.value);
  if(!isNaN(n) && n > 0){
    stageNumbers[stages[stageIndex]] = n;
    updateDisplay();
    announce();
  }
  hideModal();
});

function setupStage(el, idx){
  let lastTap = 0;
  const stageName = stages[idx];
  const textEl = el.querySelector(".stage-text");
  const zoneEl = el.querySelector(".jump-zone");

  zoneEl.addEventListener("pointerdown", () => {
    longPressTimer = setTimeout(() => {
      stageIndex = idx;
      showModal(stageName);
    }, 800);
  });
  zoneEl.addEventListener("pointerup", () => clearTimeout(longPressTimer));

  textEl.addEventListener("click", () => {
    let now = Date.now();
    stageIndex = idx;
    if(now - lastTap < 300){
      stageNumbers[stageName] = Math.max(1, stageNumbers[stageName]-1);
      lastTap = 0;
    } else {
      stageNumbers[stageName]++;
      lastTap = now;
    }
    updateDisplay();
    announce();
  });

  el.addEventListener("pointerdown", e => { startY = e.clientY; });
  el.addEventListener("pointerup", e => {
    if(startY === null) return;
    let deltaY = startY - e.clientY;
    if(Math.abs(deltaY) > 50){
      stageIndex = idx;
      if(deltaY > 0) stageNumbers[stageName]++;
      else stageNumbers[stageName] = Math.max(1, stageNumbers[stageName]-1);
      updateDisplay();
      announce();
    }
    startY = null;
  });
}

Object.values(stageEls).forEach((el, idx) => setupStage(el, idx));

loadState();
updateDisplay();
</script>
</body>
</html>
